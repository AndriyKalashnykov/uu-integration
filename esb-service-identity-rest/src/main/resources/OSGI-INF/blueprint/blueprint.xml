<?xml version="1.0" encoding="UTF-8"?>

<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0"
	xmlns:cxf="http://camel.apache.org/schema/blueprint/cxf" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jpa="http://aries.apache.org/xmlns/jpa/v1.1.0"
	xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd http://aries.apache.org/xmlns/jpa/v1.1.0 http://aries.apache.org/schemas/jpa/jpa_110.xsd"
	default-activation="eager">

	<cm:property-placeholder persistent-id="se.uu.its.integration.service.cxf.receive">
		<cm:default-properties>
			<cm:property name="CXFserver" value="http://0.0.0.0:8989/" />
			<cm:property name="service" value="esb/rest" />
		</cm:default-properties>
	</cm:property-placeholder>

	<cxf:rsServer id="rsServer" address="${CXFserver}${service}"
		serviceClass="se.uu.its.integration.service.identity.rest.IdentityService"
		loggingFeatureEnabled="true" loggingSizeLimit="20" />
		
	<bean id="modelUtils" class="se.uu.its.integration.model.common.ModelUtils" />
	<bean id="esbEventLogger" class="se.uu.its.integration.esb.logger.ESBEventLogger" />
	<bean id="deadLetterErrorHandler" class="org.apache.camel.builder.DeadLetterChannelBuilder">
		<property name="deadLetterUri" value="activemq:queue:identity-event-deadletter" />
	</bean>

        <reference id="entityManagerFactory" interface="javax.persistence.EntityManagerFactory" />
        <bean id="jpa" class="org.apache.camel.component.jpa.JpaComponent">
            <property name="entityManagerFactory" ref="entityManagerFactory"/>
            <property name="transactionManager" ref="platformTxManager"/>
        </bean>
        
        <reference id="platformTxManager" interface="org.springframework.transaction.PlatformTransactionManager" />
        <bean id="PROPAGATION_REQUIRED" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
            <property name="transactionManager" ref="platformTxManager"/>
            <property name="propagationBehaviorName" value="PROPAGATION_REQUIRED" /> 
        </bean>

	<camelContext id="IdentityService" allowUseOriginalMessage="false"
		xmlns="http://camel.apache.org/schema/blueprint">

		<route id="IdentityServiceRoute">

			<description>
				This is the REST-endpoint for messages in the identity event domain.
			</description>

			<!-- Listen for calls from REST-binded CXF-service. -->
			<from id="Identity REST endpoint" uri="cxfrs:bean:rsServer?bindingStyle=SimpleConsumer" />

			<transacted ref="PROPAGATION_REQUIRED" />
			
			<!-- 
			<to id="Convert to UUEvent 1" uri="bean:modelUtils?method=convertToUUEvent" /> 
			<to id="Log processed events" uri="jpa:se.uu.its.integration.model.events.UUEvent?persistenceUnit=logDb" />
			-->

			<!-- We use XML as internal integration language. -->
			<marshal id="XML translation">
				<jaxb prettyPrint="true" contextPath="se.uu.its.integration.model.events" />
			</marshal>

			<!-- Add integration event id. -->
			<to id="Event id assignment" uri="bean:modelUtils?method=addIntegrationEventIdToEvent" />

			<!-- Moved to bean cause camel cant load resource from other bundle. 
			<setHeader headerName="uid">
				<method bean="modelUtils" method="getNewEventId"/> 
			</setHeader> 
			<to uri="xslt:addIntegrationEventIdToEvent.xsl"/> 
			<to uri="xslt:se/uu/its/integration/model/transform/addIntegrationEventIdToEvent.xsl"/> -->
			
			<!-- Don't process already processed events. -->
			<filter id="Event processing filter">

				<method id="isEventProcessed" ref="esbEventLogger" method="isEventProcessed" />

				<inOnly id="Event distribution" uri="activemq:queue:identity-event-distribution" />

				<!-- HÃ¤r loggar vi just nu ingenting, bara skapar responsen. -->
				<to id="Log event" uri="bean:esbEventLogger?method=logEvent" />

				<unmarshal id="Object translation again">
					<jaxb prettyPrint="true" contextPath="se.uu.its.integration.model.events" />
				</unmarshal>

				<to id="Convert to UUEvent" uri="bean:modelUtils?method=convertToUUEvent" />
				<to id="Log processed events" uri="jpa:se.uu.its.integration.model.events.UUEvent?persistenceUnit=logDb" />

				<to id="TESTTESTTEST" uri="bean:esbEventLogger?method=debuggo" />
				<marshal id="XML translation again">
					<jaxb prettyPrint="true" contextPath="se.uu.its.integration.model.events" />
				</marshal>

				<!-- 
				<to id="KabooOOOOOmm" uri="bean:esbEventLogger?method=kaboom" />
				-->

				<stop id="Event processing finished" />

			</filter>

			<!-- Log not processed events. Don't passes the filter. -->
			<inOnly id="Log duplicate event" uri="activemq:queue:identity-event-duplicate" />

		</route>

	</camelContext>

</blueprint>
