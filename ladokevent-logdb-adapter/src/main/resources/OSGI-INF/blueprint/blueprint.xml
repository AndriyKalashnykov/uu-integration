<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
	xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.0.0"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

	<camelContext xmlns="http://camel.apache.org/schema/blueprint" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:ui="http://schemas.ladok.se/utbildningsinformation">
	
		<onException>
			<exception>java.lang.Exception</exception>
			<redeliveryPolicy maximumRedeliveries="-1" redeliveryDelay="5000" logStackTrace="true" />
		</onException>
		 
		<route id="ladok3event-logdb-adapter">
			<from uri="activemq:queue:ladok3event-logdb?transacted=true" />
			<setHeader headerName="category">
				<xpath resultType="java.lang.String">/atom:entry/atom:category/@term</xpath>
			</setHeader>
			<choice>
				<when>
					<xpath>/atom:entry/atom:category[@term='se.ladok.utbildningsinformation.interfaces.events.utbildning.KursTillStatus3Event']</xpath>
					<!-- Extrahera sjÃ¤lva meddelandekroppen ur XML-strukturen -->
					<setBody>
						<xpath>/atom:entry/atom:content/ui:KursTillStatus3Handelse</xpath>
					</setBody>
					<!-- Konvertera till javakod via JAXB -->
					<unmarshal>
      					<jaxb prettyPrint="true" contextPath="se.sunet.ati.ladok.atom.dto"/>
    				</unmarshal>
    				 
					<!--  Nu har vi ett KursTillStatus3Handelse-objekt. Notera "BodyType" i loggen -->
					<to uri="log:ladok-logdb?level=INFO" />
				</when>
				<otherwise>
					<to uri="bean:unknownEventLogger?method=dumpUnknownEntry" />
					<setBody>
						<simple>Unknown event ${header.category}</simple>
					</setBody>
					<to uri="log:ladok-logdb?level=ERROR" />
				</otherwise>
			</choice> 
		</route>
	</camelContext>

	<bean id="shutdown" class="org.apache.camel.impl.DefaultShutdownStrategy">  
  		<property name="timeout" value="10"/>
	</bean>  

	<bean id="jmsTransactionManager"
		class="org.springframework.jms.connection.JmsTransactionManager">
		<property name="connectionFactory" ref="jmsConnectionFactory" />
	</bean>

	<bean id="jmsConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory">
		<property name="brokerURL" value="tcp://localhost:61616" />
        <property name="userName" value="smx" />
        <property name="password" value="smx" />
	</bean>

	<bean id="activemq" class="org.apache.activemq.camel.component.ActiveMQComponent">
		<property name="connectionFactory" ref="jmsConnectionFactory" />
		<property name="transacted" value="true" />
	</bean>

	<bean id="NEW" class="org.apache.camel.spring.spi.SpringTransactionPolicy">
		<property name="transactionManager" ref="jmsTransactionManager" />
		<property name="propagationBehaviorName" value="PROPAGATION_REQUIRES_NEW" />
	</bean>
	
	<bean id="unknownEventLogger" class="se.sunet.ati.ladok.atom.UnknownEventLogger" />
	
</blueprint>
